@inject IDialogService DialogService
@inject NavigationManager Navigation
@using Microsoft.AspNetCore.SignalR.Client

<div>
    @foreach (var request in Requests)
    {
        <MudList>
            <MudListItem>
                <RequestComponent Request=@request OnView="@(async () => await ViewAsync(request))"></RequestComponent>
            </MudListItem>
        </MudList>
    }

</div>

@code {
    private HubConnection? hubConnection;
    private List<RequestDto> Requests = new List<RequestDto>();

    private async Task ViewAsync(RequestDto request)
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            CloseButton = true,
            FullWidth = true,
            MaxWidth = MaxWidth.Small,
        };
        var parameters = new DialogParameters
        {
            ["Request"] = request
        };
        await DialogService.ShowAsync<ViewRequestComponent>("Request", parameters, options);
    }

    private bool IsConnected => hubConnection?.State == HubConnectionState.Connected;

    private async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var url = Navigation.ToAbsoluteUri("/request-rule-events");
        hubConnection = new HubConnectionBuilder()
            .WithUrl(url)
            .Build();

        hubConnection.On<RequestDto>("RequestRuleEventCaught", (request) =>
        {
            if (request is not null)
            {
                Requests.Add(request);
                StateHasChanged();
            }
        });

        await hubConnection.StartAsync();
    }
}
